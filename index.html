<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Tiếng Nhật - Thể Thường (普通形)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #fce38a 0%, #f38181 100%);
            
            --primary-color: #667eea;
            --secondary-color: #f5576c;
            --accent-color: #4facfe;
            --success-color: #38ef7d;
            --warning-color: #f38181;
            --error-color: #ff6b6b;
            
            --bg-light: #fafbfc;
            --bg-dark: #0f0f1a;
            --surface-light: #ffffff;
            --surface-dark: #1a1a2e;
            --text-light: #2d3748;
            --text-dark: #e2e8f0;
            --text-secondary-light: #718096;
            --text-secondary-dark: #a0aec0;
            --border-light: #e2e8f0;
            --border-dark: #2d3748;
            
            --glass-bg-light: rgba(255, 255, 255, 0.7);
            --glass-bg-dark: rgba(26, 26, 46, 0.7);
            --glass-border-light: rgba(255, 255, 255, 0.2);
            --glass-border-dark: rgba(255, 255, 255, 0.1);
            
            --shadow-light: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-hover-light: 0 20px 40px rgba(0, 0, 0, 0.15);
            --shadow-dark: 0 10px 25px rgba(0, 0, 0, 0.3);
            --shadow-hover-dark: 0 20px 40px rgba(0, 0, 0, 0.5);
            
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
            
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        [data-theme="light"] {
            --bg-color: var(--bg-light);
            --surface-color: var(--surface-light);
            --text-color: var(--text-light);
            --text-secondary: var(--text-secondary-light);
            --border-color: var(--border-light);
            --glass-bg: var(--glass-bg-light);
            --glass-border: var(--glass-border-light);
            --shadow: var(--shadow-light);
            --shadow-hover: var(--shadow-hover-light);
        }

        [data-theme="dark"] {
            --bg-color: var(--bg-dark);
            --surface-color: var(--surface-dark);
            --text-color: var(--text-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-color: var(--border-dark);
            --glass-bg: var(--glass-bg-dark);
            --glass-border: var(--glass-border-dark);
            --shadow: var(--shadow-dark);
            --shadow-hover: var(--shadow-hover-dark);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: all var(--transition-normal);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.03;
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background: var(--primary-gradient); }
            33% { background: var(--secondary-gradient); }
            66% { background: var(--accent-gradient); }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--surface-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 2px;
            animation: loadingProgress 2s ease-in-out;
        }

        @keyframes loadingProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: var(--border-radius-xl);
            padding: 40px;
            max-width: 90%;
            max-height: 90%;
            width: 500px;
            box-shadow: var(--shadow-hover);
            animation: slideUp 0.3s ease;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                transform: translateY(50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .modal-close:hover {
            background: var(--error-color);
            color: white;
            transform: scale(1.1);
        }

        /* Glassmorphism Container */
        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: all var(--transition-normal);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--transition-normal);
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .nav-menu {
            display: flex;
            gap: 8px;
            list-style: none;
        }

        .nav-link {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            padding: 12px 20px;
            border-radius: var(--border-radius-xl);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: left var(--transition-normal);
            z-index: -1;
        }

        .nav-link:hover::before,
        .nav-link.active::before {
            left: 0;
        }

        .nav-link:hover,
        .nav-link.active {
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .theme-toggle {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all var(--transition-normal);
            font-size: 1.1rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: var(--shadow);
        }

        /* Main Content */
        .main-content {
            padding: 40px 0;
            min-height: calc(100vh - 74px);
        }

        .page {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        /* Hero Section */
        .hero-section {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
        }

        .hero-title {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Mind Map with Modern Design */
        .mindmap-container {
            background: var(--surface-color);
            border-radius: var(--border-radius-xl);
            padding: 50px;
            margin-bottom: 50px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .mindmap-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: var(--primary-gradient);
            opacity: 0.03;
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .mindmap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            position: relative;
            z-index: 1;
        }

        .mindmap-title {
            text-align: center;
            margin-bottom: 40px;
            color: var(--text-color);
            font-size: 2rem;
            font-weight: 700;
        }

        .central-node {
            background: var(--primary-gradient);
            color: white;
            padding: 30px 50px;
            border-radius: var(--border-radius-xl);
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            box-shadow: var(--shadow);
            transform: scale(1);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .central-node::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s ease;
        }

        .central-node:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .central-node:hover::before {
            left: 100%;
        }

        .branches {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            width: 100%;
        }

        .branch {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            text-align: center;
            transition: all var(--transition-normal);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .branch::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform var(--transition-normal);
        }

        .branch:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
            border-color: transparent;
        }

        .branch:hover::before {
            transform: scaleX(1);
        }

        .branch-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .branch-examples {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .example {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(245, 87, 108, 0.1));
            padding: 12px 16px;
            border-radius: var(--border-radius-md);
            font-size: 0.95rem;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all var(--transition-fast);
        }

        .example:hover {
            transform: scale(1.02);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(245, 87, 108, 0.15));
        }

        /* Modern Card Grid */
        .theory-cards,
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .theory-card,
        .exercise-card {
            background: var(--surface-color);
            border-radius: var(--border-radius-lg);
            padding: 35px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .theory-card::before,
        .exercise-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity var(--transition-normal);
            z-index: -1;
        }

        .theory-card:hover,
        .exercise-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-hover);
            color: white;
        }

        .theory-card:hover::before,
        .exercise-card:hover::before {
            opacity: 0.9;
        }

        .card-title,
        .exercise-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: color var(--transition-normal);
        }

        .theory-card:hover .card-title,
        .exercise-card:hover .exercise-title {
            color: white;
        }

        /* Practice Dashboard */
        .practice-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .stat-card {
            background: var(--surface-color);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--success-gradient);
            transform: scaleX(0);
            transition: transform var(--transition-normal);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-color);
            position: relative;
        }

        /* Blinking icon for total questions */
        .blink-icon {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--warning-gradient);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            animation: blink 1.5s infinite;
            transition: all var(--transition-normal);
        }

        .blink-icon:hover {
            transform: scale(1.2);
            animation: none;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Exercise Cards */
        .exercise-card {
            cursor: pointer;
            position: relative;
        }

        .exercise-card.completed::after {
            content: '✓';
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--success-gradient);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: var(--shadow);
        }

        .exercise-description {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
            transition: color var(--transition-normal);
        }

        .exercise-card:hover .exercise-description {
            color: rgba(255, 255, 255, 0.9);
        }

        .exercise-progress {
            background: var(--border-color);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .exercise-progress-bar {
            height: 100%;
            background: var(--success-gradient);
            border-radius: 4px;
            transition: width var(--transition-slow);
        }

        /* Resume indicator */
        .resume-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--warning-gradient);
            color: white;
            padding: 5px 10px;
            border-radius: var(--border-radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Quiz Interface */
        .quiz-container {
            background: var(--surface-color);
            border-radius: var(--border-radius-xl);
            padding: 50px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: none;
            position: relative;
            overflow: hidden;
        }

        .quiz-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
        }

        .quiz-container.active {
            display: block;
            animation: slideInFromRight 0.6s ease;
        }

        @keyframes slideInFromRight {
            from { 
                transform: translateX(50px);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 25px;
            border-bottom: 2px solid var(--border-color);
        }

        .quiz-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .quiz-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            width: 250px;
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 6px;
            transition: width var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .question-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(245, 87, 108, 0.05));
            border-radius: var(--border-radius-lg);
            padding: 40px;
            margin-bottom: 30px;
            border-left: 5px solid;
            border-image: var(--primary-gradient) 1;
            position: relative;
        }

        .question-text {
            font-size: 1.3rem;
            margin-bottom: 25px;
            line-height: 1.6;
            font-weight: 500;
        }

        .japanese-text {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 15px 0;
        }

        .answer-input {
            width: 100%;
            padding: 20px 25px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            font-size: 1.2rem;
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--surface-color);
            color: var(--text-color);
            transition: all var(--transition-normal);
            font-weight: 500;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: scale(1.01);
        }

        /* Mobile responsive placeholder */
        @media (max-width: 768px) {
            .answer-input {
                font-size: 1rem;
                padding: 15px 20px;
            }
            
            .answer-input::placeholder {
                font-size: 0.9rem;
            }
        }

        /* Modern Buttons */
        .quiz-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: var(--border-radius-xl);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-width: 140px;
            justify-content: center;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
            transform: translateY(-3px);
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: white;
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* Feedback Messages */
        .feedback {
            padding: 25px;
            border-radius: var(--border-radius-lg);
            margin-top: 25px;
            font-weight: 600;
            text-align: center;
            animation: bounceIn 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        @keyframes bounceIn {
            0% { 
                transform: scale(0.3);
                opacity: 0;
            }
            50% { 
                transform: scale(1.05);
            }
            70% { 
                transform: scale(0.9);
            }
            100% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        .feedback.correct {
            background: linear-gradient(135deg, rgba(56, 239, 125, 0.1), rgba(17, 153, 142, 0.1));
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .feedback.incorrect {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(243, 129, 129, 0.1));
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }

        /* Results */
        .results-container {
            text-align: center;
            padding: 50px;
            background: var(--surface-color);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .results-score {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 20px;
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .results-message {
            font-size: 1.4rem;
            margin-bottom: 40px;
            color: var(--text-secondary);
        }

        /* Enhanced Results Stats */
        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 20px;
            margin: 30px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .results-stat {
            text-align: center;
        }

        .results-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .results-stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .correct-stat { color: var(--success-color); }
        .wrong-stat { color: var(--error-color); }
        .skipped-stat { color: var(--warning-color); }

        /* Answer Review Section */
        .answer-review {
            background: var(--surface-color);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            margin-top: 30px;
            border: 1px solid var(--border-color);
        }

        .review-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .review-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius-md);
            border-left: 4px solid;
        }

        .review-item.correct {
            background: rgba(56, 239, 125, 0.1);
            border-color: var(--success-color);
        }

        .review-item.incorrect {
            background: rgba(255, 107, 107, 0.1);
            border-color: var(--error-color);
        }

        .review-item.skipped {
            background: rgba(248, 181, 0, 0.1);
            border-color: var(--warning-color);
        }

        .review-question {
            font-family: 'Noto Sans JP', sans-serif;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .review-answer {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Export Table */
        .export-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            display: block;
        }

        .export-table thead,
        .export-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .export-table th,
        .export-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            word-wrap: break-word;
        }

        .export-table th {
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .export-table tbody {
            overflow-y: auto;
            max-height: 300px;
        }

        .export-table tr:hover td {
            background: rgba(102, 126, 234, 0.05);
        }

        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Rule Table */
        .rule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .rule-table th {
            background: var(--primary-gradient);
            color: white;
            padding: 18px;
            font-weight: 600;
            text-align: left;
        }

        .rule-table td {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border-color);
            font-family: 'Noto Sans JP', sans-serif;
            transition: background var(--transition-fast);
        }

        .rule-table tr:hover td {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(245, 87, 108, 0.05));
        }

        /* Error Message */
        .error-message {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(243, 129, 129, 0.1));
            border: 2px solid var(--error-color);
            border-radius: var(--border-radius-lg);
            color: var(--error-color);
            margin: 20px 0;
        }

        .error-message h3 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .error-message p {
            margin-bottom: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .header-content {
                flex-wrap: wrap;
                gap: 15px;
            }

            .nav-menu {
                gap: 5px;
            }

            .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .logo {
                font-size: 1.5rem;
            }

            .hero-title {
                font-size: 2.5rem;
            }

            .mindmap-container,
            .quiz-container {
                padding: 25px;
            }

            .branches {
                grid-template-columns: 1fr;
            }

            .quiz-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .progress-bar {
                width: 100%;
            }

            .quiz-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            .theory-cards,
            .exercise-grid {
                grid-template-columns: 1fr;
            }

            .practice-dashboard {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .modal-content {
                width: 95%;
                margin: 20px;
                padding: 25px;
            }

            .export-table {
                font-size: 0.85rem;
            }

            .export-table th,
            .export-table td {
                padding: 8px;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for accessibility */
        .btn:focus,
        .answer-input:focus,
        .nav-link:focus,
        .theme-toggle:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --text-color: #000000;
            }
            
            [data-theme="dark"] {
                --border-color: #ffffff;
                --text-color: #ffffff;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="animated-bg"></div>
    
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Đang tải dữ liệu...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Continue Modal -->
    <div class="modal" id="continue-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-play-circle"></i> Tiếp Tục Bài Tập
                </div>
                <button class="modal-close" onclick="closeContinueModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px;">Bạn đang làm ở câu <strong id="continue-question-number">1</strong> trong bài tập <strong id="continue-exercise-name">Động Từ - Hiện Tại</strong>.</p>
                <p style="margin-bottom: 30px;">Bạn có muốn tiếp tục từ vị trí này không?</p>
                <div class="quiz-buttons">
                    <button class="btn btn-primary" onclick="continueExercise()">
                        <i class="fas fa-play"></i> Tiếp Tục
                    </button>
                    <button class="btn btn-secondary" onclick="restartExercise()">
                        <i class="fas fa-redo"></i> Làm Lại Từ Đầu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-download"></i> Xuất Câu Hỏi & Đáp Án
                </div>
                <button class="modal-close" onclick="closeExportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <p>Tổng số câu hỏi: <strong id="export-total-questions">0</strong></p>
                </div>
                <div style="overflow-x: auto;">
                    <table class="export-table" id="export-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="width: 40%;">Câu Hỏi</th>
                                <th style="width: 25%;">Đáp Án</th>
                                <th style="width: 30%;">Dịch Nghĩa</th>
                            </tr>
                        </thead>
                        <tbody id="export-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Xuất Excel
                    </button>
                    <button class="btn btn-primary" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Xuất PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-torii-gate"></i>
                    日本語学習 - 普通形
                </div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="#" class="nav-link active" data-page="theory">
                            <i class="fas fa-book"></i> Lí Thuyết
                        </a></li>
                        <li><a href="#" class="nav-link" data-page="practice">
                            <i class="fas fa-pencil-alt"></i> Thực Hành
                        </a></li>
                    </ul>
                </nav>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Chuyển đổi chế độ sáng/tối">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- Theory Page -->
            <div class="page active" id="theory-page">
                <div class="hero-section">
                    <h1 class="hero-title">Thể Thường (普通形)</h1>
                    <p class="hero-subtitle">Nắm vững kiến thức cơ bản về thể thường trong tiếng Nhật một cách dễ dàng và trực quan</p>
                </div>

                <div class="mindmap-container glass-container">
                    <h2 class="mindmap-title">
                        <i class="fas fa-sitemap"></i> Sơ Đồ Tư Duy - Thể Thường
                    </h2>
                    <div class="mindmap">
                        <div class="central-node">
                            普通形<br><small style="font-size: 0.8em;">(Thể Thường)</small>
                        </div>
                        <div class="branches">
                            <div class="branch">
                                <div class="branch-title">
                                    <i class="fas fa-running"></i> Động Từ (動詞)
                                </div>
                                <div class="branch-examples">
                                    <div class="example">Hiện tại: いきます → いく</div>
                                    <div class="example">Quá khứ: いきました → いった</div>
                                    <div class="example">Phủ định: いきません → いかない</div>
                                    <div class="example">Quá khứ PĐ: いきませんでした → いかなかった</div>
                                </div>
                            </div>
                            <div class="branch">
                                <div class="branch-title">
                                    <i class="fas fa-palette"></i> Tính Từ い
                                </div>
                                <div class="branch-examples">
                                    <div class="example">おいしいです → おいしい</div>
                                    <div class="example">おいしかったです → おいしかった</div>
                                    <div class="example">おいしくないです → おいしくない</div>
                                    <div class="example">おいしくなかったです → おいしくなかった</div>
                                </div>
                            </div>
                            <div class="branch">
                                <div class="branch-title">
                                    <i class="fas fa-star"></i> Tính Từ な
                                </div>
                                <div class="branch-examples">
                                    <div class="example">きれいです → きれいだ</div>
                                    <div class="example">きれいでした → きれいだった</div>
                                    <div class="example">きれいじゃありません → きれいじゃない</div>
                                    <div class="example">きれいじゃありませんでした → きれいじゃなかった</div>
                                </div>
                            </div>
                            <div class="branch">
                                <div class="branch-title">
                                    <i class="fas fa-cube"></i> Danh Từ (名詞)
                                </div>
                                <div class="branch-examples">
                                    <div class="example">がくせいです → がくせいだ</div>
                                    <div class="example">がくせいでした → がくせいだった</div>
                                    <div class="example">がくせいじゃありません → がくせいじゃない</div>
                                    <div class="example">がくせいじゃありませんでした → がくせいじゃなかった</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="theory-cards">
                    <div class="theory-card">
                        <h3 class="card-title">
                            <i class="fas fa-info-circle"></i> Thể Thường là gì?
                        </h3>
                        <p>Thể Thường (普通形) là một trong những thể của động từ, tính từ và danh từ trong tiếng Nhật. Nó được sử dụng trong:</p>
                        <ul style="margin-top: 15px; padding-left: 20px; line-height: 1.8;">
                            <li>🗣️ Các tình huống thân mật, không trang trọng</li>
                            <li>👫 Nói chuyện với bạn bè, người thân</li>
                            <li>📝 Văn viết không yêu cầu sự trang trọng (blog, diary, manga)</li>
                            <li>🔗 Kết hợp với các mẫu ngữ pháp đặc biệt</li>
                        </ul>
                    </div>

                    <div class="theory-card">
                        <h3 class="card-title">
                            <i class="fas fa-exchange-alt"></i> Quy Tắc Chuyển Đổi
                        </h3>
                        <table class="rule-table">
                            <thead>
                                <tr>
                                    <th>Loại từ</th>
                                    <th>Thể Lịch Sự</th>
                                    <th>Thể Thường</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Động từ (hiện tại)</strong></td>
                                    <td>Vます</td>
                                    <td>Vる</td>
                                </tr>
                                <tr>
                                    <td><strong>Động từ (quá khứ)</strong></td>
                                    <td>Vました</td>
                                    <td>Vた</td>
                                </tr>
                                <tr>
                                    <td><strong>Động từ (phủ định)</strong></td>
                                    <td>Vません</td>
                                    <td>Vない</td>
                                </tr>
                                <tr>
                                    <td><strong>Tính từ い</strong></td>
                                    <td>Aいです</td>
                                    <td>Aい</td>
                                </tr>
                                <tr>
                                    <td><strong>Tính từ な</strong></td>
                                    <td>Aなです</td>
                                    <td>Aだ</td>
                                </tr>
                                <tr>
                                    <td><strong>Danh từ</strong></td>
                                    <td>Nです</td>
                                    <td>Nだ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="theory-card">
                        <h3 class="card-title">
                            <i class="fas fa-lightbulb"></i> Mẹo Học Tập
                        </h3>
                        <ul style="padding-left: 20px; line-height: 1.8;">
                            <li>🔄 <strong>Luyện tập thường xuyên</strong> với bạn bè người Nhật</li>
                            <li>🎬 <strong>Xem anime, drama</strong> để nghe thể thường trong thực tế</li>
                            <li>📱 <strong>Đọc manga, tin nhắn</strong> social media</li>
                            <li>🎯 <strong>Đừng sợ sai</strong> - học từ sai lầm</li>
                            <li>📚 <strong>Ôn lại kiến thức</strong> định kỳ</li>
                            <li>🗣️ <strong>Thực hành với AI chatbot</strong> tiếng Nhật</li>
                        </ul>
                    </div>

                    <div class="theory-card">
                        <h3 class="card-title">
                            <i class="fas fa-puzzle-piece"></i> Ứng Dụng Thực Tế
                        </h3>
                        <p>Thể thường thường xuất hiện trong các mẫu ngữ pháp:</p>
                        <div style="margin-top: 20px;">
                            <div class="example" style="margin-bottom: 10px;">
                                <strong>と思います</strong> - tôi nghĩ rằng...
                            </div>
                            <div class="example" style="margin-bottom: 10px;">
                                <strong>でしょう</strong> - có lẽ, phải không
                            </div>
                            <div class="example" style="margin-bottom: 10px;">
                                <strong>かもしれません</strong> - có thể
                            </div>
                            <div class="example" style="margin-bottom: 10px;">
                                <strong>時、前に、後で</strong> - khi, trước, sau
                            </div>
                            <div class="example">
                                <strong>ので、のに</strong> - vì, mặc dù
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Practice Page -->
            <div class="page" id="practice-page">
                <div class="hero-section">
                    <h1 class="hero-title">Thực Hành Bài Tập</h1>
                    <p class="hero-subtitle">Luyện tập và kiểm tra kiến thức thể thường của bạn qua các bài tập tương tác</p>
                </div>

                <!-- Stats Dashboard -->
                <div class="practice-dashboard">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value" id="correct-count">0</div>
                        <div class="stat-label">Câu Đúng</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="stat-value" id="total-count">0
                            <div class="blink-icon" onclick="showExportModal()" title="Xem và xuất tất cả câu hỏi">
                                <i class="fas fa-download"></i>
                            </div>
                        </div>
                        <div class="stat-label">Tổng Câu</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-value" id="streak-count">0</div>
                        <div class="stat-label">Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-value" id="accuracy-rate">0%</div>
                        <div class="stat-label">Độ Chính Xác</div>
                    </div>
                </div>

                <!-- Exercise Selection -->
                <div class="exercise-grid" id="exercise-selection">
                    <!-- Exercises will be populated by JavaScript -->
                </div>

                <!-- Quiz Container -->
                <div class="quiz-container" id="quiz-container">
                    <div class="quiz-header">
                        <div class="quiz-title" id="quiz-title">Bài Tập</div>
                        <div class="quiz-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="quiz-progress-fill" style="width: 0%"></div>
                            </div>
                            <span id="quiz-progress-text">1/25</span>
                        </div>
                    </div>

                    <div class="question-card">
                        <div class="question-text" id="question-text">
                            Chuyển câu sau sang thể thường:
                        </div>
                        <div class="japanese-text" id="japanese-sentence">
                            がっこうに いきます。
                        </div>
                        <div style="margin: 10px 0; font-style: italic; color: var(--text-secondary);" id="vietnamese-meaning">
                            (đi học)
                        </div>
                        <div style="margin-bottom: 20px; font-size: 1.1rem;">
                            → <span id="sentence-prefix">がっこうに</span> <span style="border-bottom: 2px dashed var(--primary-color); padding: 5px 15px; min-width: 120px; display: inline-block; text-align: center;">_____</span>。
                        </div>
                        <input type="text" class="answer-input" id="answer-input" placeholder="Nhập đáp án..." autocomplete="off">
                    </div>

                    <div class="quiz-buttons">
                        <button class="btn btn-secondary" onclick="showHint()" id="hint-btn">
                            <i class="fas fa-lightbulb"></i> Gợi Ý
                        </button>
                        <button class="btn btn-primary" onclick="checkAnswer()" id="check-btn">
                            <i class="fas fa-check"></i> Kiểm Tra
                        </button>
                        <button class="btn btn-success" onclick="nextQuestion()" id="next-btn" style="display: none;">
                            <i class="fas fa-arrow-right"></i> Tiếp Theo
                        </button>
                    </div>

                    <div id="feedback"></div>

                    <div class="quiz-buttons" style="margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                        <button class="btn btn-secondary" onclick="backToSelection()">
                            <i class="fas fa-arrow-left"></i> Quay Lại
                        </button>
                        <button class="btn btn-warning" onclick="skipQuestion()" id="skip-btn">
                            <i class="fas fa-forward"></i> Bỏ Qua
                        </button>
                    </div>
                </div>

                <!-- Results Container -->
                <div class="results-container" id="results-container" style="display: none;">
                    <div style="margin-bottom: 30px;">
                        <i class="fas fa-trophy" style="font-size: 4rem; color: var(--warning-color); margin-bottom: 20px;"></i>
                    </div>
                    <div class="results-score" id="results-score">0/0</div>
                    <div class="results-message" id="results-message">Chúc mừng bạn đã hoàn thành bài tập!</div>
                    
                    <div class="results-stats">
                        <div class="results-stat">
                            <div class="results-stat-value correct-stat" id="final-correct">0</div>
                            <div class="results-stat-label">Đúng</div>
                        </div>
                        <div class="results-stat">
                            <div class="results-stat-value wrong-stat" id="final-wrong">0</div>
                            <div class="results-stat-label">Sai</div>
                        </div>
                        <div class="results-stat">
                            <div class="results-stat-value skipped-stat" id="final-skipped">0</div>
                            <div class="results-stat-label">Bỏ qua</div>
                        </div>
                    </div>

                    <!-- Answer Review Section -->
                    <div class="answer-review" id="answer-review">
                        <div class="review-title">
                            <i class="fas fa-clipboard-check"></i> Xem Lại Đáp Án
                        </div>
                        <div id="review-content">
                            <!-- Review items will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="quiz-buttons">
                        <button class="btn btn-primary" onclick="retryExercise()">
                            <i class="fas fa-redo"></i> Làm Lại
                        </button>
                        <button class="btn btn-secondary" onclick="backToSelection()">
                            <i class="fas fa-home"></i> Về Trang Chủ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // App Configuration
        const APP_CONFIG = {
            STORAGE_KEY: 'japaneseApp',
            ANIMATION_DURATION: 300,
            AUTO_SAVE_INTERVAL: 5000,
            QUESTIONS_URL: './questions.json',
            ANSWERS_URL: './answers.json'
        };

        // Exercise Definitions
        const EXERCISE_DEFINITIONS = {
            'verbs-present': {
                title: 'Động Từ - Hiện Tại',
                description: '25 câu luyện tập chuyển đổi động từ hiện tại từ thể lịch sự sang thể thường',
                icon: 'fas fa-play',
                color: 'var(--primary-color)'
            },
            'verbs-past': {
                title: 'Động Từ - Quá Khứ', 
                description: '25 câu luyện tập chuyển đổi động từ quá khứ từ thể lịch sự sang thể thường',
                icon: 'fas fa-history',
                color: 'var(--secondary-color)'
            },
            'verbs-negative': {
                title: 'Động Từ - Phủ Định',
                description: '25 câu luyện tập chuyển đổi động từ phủ định từ thể lịch sự sang thể thường',
                icon: 'fas fa-times-circle',
                color: 'var(--error-color)'
            },
            'verbs-past-negative': {
                title: 'Động Từ - Quá Khứ Phủ Định',
                description: '25 câu luyện tập chuyển đổi động từ quá khứ phủ định từ thể lịch sự sang thể thường',
                icon: 'fas fa-minus-circle',
                color: '#9b59b6'
            },
            'verbs-advanced-1': {
                title: 'Động Từ Nâng Cao - Phần 1',
                description: '25 câu luyện tập động từ phức tạp và hoạt động hàng ngày',
                icon: 'fas fa-star',
                color: '#e74c3c'
            },
            'verbs-advanced-2': {
                title: 'Động Từ Nâng Cao - Phần 2',
                description: '25 câu luyện tập động từ tự nhiên và hiện tượng thời tiết',
                icon: 'fas fa-cloud-sun',
                color: '#f39c12'
            },
            'adjectives-i': {
                title: 'Tính Từ い',
                description: '20 câu luyện tập chuyển đổi tính từ đuôi い từ thể lịch sự sang thể thường',
                icon: 'fas fa-palette',
                color: 'var(--accent-color)'
            },
            'adjectives-na': {
                title: 'Tính Từ な',
                description: '20 câu luyện tập chuyển đổi tính từ đuôi な từ thể lịch sự sang thể thường',
                icon: 'fas fa-star',
                color: 'var(--warning-color)'
            },
            'adjectives-advanced': {
                title: 'Tính Từ Nâng Cao',
                description: '20 câu luyện tập tính từ mô tả vị giác, cảm giác và đặc điểm',
                icon: 'fas fa-seedling',
                color: '#27ae60'
            },
            'nouns': {
                title: 'Danh Từ',
                description: '20 câu luyện tập chuyển đổi danh từ từ thể lịch sự sang thể thường',
                icon: 'fas fa-cube',
                color: 'var(--success-color)'
            },
            'nouns-advanced': {
                title: 'Danh Từ Nâng Cao',
                description: '20 câu luyện tập thứ trong tuần, mùa và nghề nghiệp',
                icon: 'fas fa-briefcase',
                color: '#8e44ad'
            },
            'grammar-patterns-must': {
                title: 'Ngữ Pháp - Phải Làm',
                description: '12 câu luyện tập mẫu なければなりません → なければならない',
                icon: 'fas fa-exclamation-triangle',
                color: '#e67e22'
            },
            'grammar-patterns-ing': {
                title: 'Ngữ Pháp - Đang Làm',
                description: '12 câu luyện tập mẫu ています → ている',
                icon: 'fas fa-clock',
                color: '#3498db'
            },
            'grammar-patterns-forbidden': {
                title: 'Ngữ Pháp - Không Được',
                description: '12 câu luyện tập mẫu てはいけません → てはいけない',
                icon: 'fas fa-ban',
                color: '#e74c3c'
            },
            'grammar-patterns-permission': {
                title: 'Ngữ Pháp - Có Thể Làm',
                description: '12 câu luyện tập mẫu てもいいです → てもいい',
                icon: 'fas fa-check-circle',
                color: '#27ae60'
            },
            'grammar-patterns-ability': {
                title: 'Ngữ Pháp - Có Khả Năng',
                description: '12 câu luyện tập mẫu ことができます → ことができる',
                icon: 'fas fa-medal',
                color: '#f39c12'
            },
            'grammar-patterns-experience': {
                title: 'Ngữ Pháp - Đã Từng',
                description: '12 câu luyện tập mẫu ことがあります → ことがある',
                icon: 'fas fa-history',
                color: '#8e44ad'
            },
            'grammar-patterns-alternation': {
                title: 'Ngữ Pháp - Làm Này Làm Kia',
                description: '12 câu luyện tập mẫu たりします → たりする',
                icon: 'fas fa-exchange-alt',
                color: '#16a085'
            },
            'grammar-patterns-become': {
                title: 'Ngữ Pháp - Trở Nên',
                description: '12 câu luyện tập mẫu なります → なる',
                icon: 'fas fa-arrow-up',
                color: '#2980b9'
            },
            'complex-grammar-1': {
                title: 'Ngữ Pháp Phức Tạp - Phần 1',
                description: '15 câu luyện tập でしょう, と思います, そうです',
                icon: 'fas fa-brain',
                color: '#6c5ce7'
            },
            'complex-grammar-2': {
                title: 'Ngữ Pháp Phức Tạp - Phần 2', 
                description: '15 câu luyện tập てくれる, てあげる, てもらう',
                icon: 'fas fa-hands-helping',
                color: '#fd79a8'
            },
            'complex-grammar-3': {
                title: 'Ngữ Pháp Phức Tạp - Phần 3',
                description: '15 câu luyện tập ので, のに, てから',
                icon: 'fas fa-link',
                color: '#00b894'
            },
            'situational-expressions': {
                title: 'Biểu Hiện Tình Huống',
                description: '15 câu luyện tập giao tiếp hàng ngày với ですね, ですか',
                icon: 'fas fa-comments',
                color: '#a29bfe'
            },
            'weather-time-expressions': {
                title: 'Thời Tiết & Thời Gian',
                description: '10 câu luyện tập mô tả thời tiết và thời gian',
                icon: 'fas fa-clock',
                color: '#74b9ff'
            },
            'family-relationships': {
                title: 'Gia Đình & Mối Quan Hệ',
                description: '10 câu luyện tập về gia đình và các mối quan hệ',
                icon: 'fas fa-users',
                color: '#fd79a8'
            },
            'food-cooking': {
                title: 'Đồ Ăn & Nấu Nướng',
                description: '10 câu luyện tập về thức ăn và hoạt động nấu nướng',
                icon: 'fas fa-utensils',
                color: '#fdcb6e'
            },
            'transportation': {
                title: 'Phương Tiện Giao Thông',
                description: '10 câu luyện tập về các phương tiện di chuyển',
                icon: 'fas fa-car',
                color: '#00b894'
            }
        };

        // App State Management
        class AppState {
            constructor() {
                this.currentExercise = null;
                this.currentQuestionIndex = 0;
                this.sessionStats = {
                    correct: 0,
                    total: 0,
                    streak: 0,
                    skipped: 0
                };
                this.sessionResults = []; // Store session results for review
                this.globalStats = this.loadGlobalStats();
                this.questionsData = {};
                this.answersData = {};
                this.isDataLoaded = false;
            }

            loadGlobalStats() {
                const saved = localStorage.getItem(APP_CONFIG.STORAGE_KEY);
                return saved ? JSON.parse(saved) : {
                    totalCorrect: 0,
                    totalQuestions: 0,
                    maxStreak: 0,
                    exerciseProgress: {},
                    exerciseCurrentQuestion: {}, // Track current question for each exercise
                    lastAccessed: new Date().toISOString()
                };
            }

            saveGlobalStats() {
                this.globalStats.lastAccessed = new Date().toISOString();
                localStorage.setItem(APP_CONFIG.STORAGE_KEY, JSON.stringify(this.globalStats));
            }

            updateStats(isCorrect, isSkipped = false, questionData = null) {
                this.sessionStats.total++;
                this.globalStats.totalQuestions++;
                
                // Store result for review
                if (questionData) {
                    this.sessionResults.push({
                        question: questionData.question,
                        userAnswer: questionData.userAnswer,
                        correctAnswer: questionData.correctAnswer,
                        explanation: questionData.explanation,
                        meaning: questionData.meaning,
                        isCorrect: isCorrect,
                        isSkipped: isSkipped
                    });
                }
                
                if (isCorrect) {
                    this.sessionStats.correct++;
                    this.sessionStats.streak++;
                    this.globalStats.totalCorrect++;
                    this.globalStats.maxStreak = Math.max(this.globalStats.maxStreak, this.sessionStats.streak);
                } else if (isSkipped) {
                    this.sessionStats.skipped++;
                    this.sessionStats.streak = 0;
                } else {
                    this.sessionStats.streak = 0;
                }
                
                this.updateStatsDisplay();
                this.saveGlobalStats();
            }

            updateStatsDisplay() {
                document.getElementById('correct-count').textContent = this.globalStats.totalCorrect;
                document.getElementById('total-count').textContent = this.globalStats.totalQuestions;
                document.getElementById('streak-count').textContent = this.sessionStats.streak;
                
                const accuracy = this.globalStats.totalQuestions > 0 
                    ? Math.round((this.globalStats.totalCorrect / this.globalStats.totalQuestions) * 100)
                    : 0;
                document.getElementById('accuracy-rate').textContent = accuracy + '%';
            }

            saveExerciseProgress(exerciseType, questionIndex) {
                if (!this.globalStats.exerciseCurrentQuestion) {
                    this.globalStats.exerciseCurrentQuestion = {};
                }
                this.globalStats.exerciseCurrentQuestion[exerciseType] = questionIndex;
                this.saveGlobalStats();
            }

            getExerciseProgress(exerciseType) {
                return this.globalStats.exerciseCurrentQuestion?.[exerciseType] || 0;
            }

            clearExerciseProgress(exerciseType) {
                if (this.globalStats.exerciseCurrentQuestion) {
                    delete this.globalStats.exerciseCurrentQuestion[exerciseType];
                    this.saveGlobalStats();
                }
            }
        }

        // Initialize App State
        const appState = new AppState();

        // Data Loading Functions
        async function loadJSONData() {
            try {
                const loadingText = document.querySelector('.loading-text');
                
                loadingText.textContent = 'Đang tải câu hỏi...';
                const questionsResponse = await fetch(APP_CONFIG.QUESTIONS_URL);
                if (!questionsResponse.ok) {
                    throw new Error(`HTTP error! status: ${questionsResponse.status}`);
                }
                appState.questionsData = await questionsResponse.json();
                
                loadingText.textContent = 'Đang tải đáp án...';
                const answersResponse = await fetch(APP_CONFIG.ANSWERS_URL);
                if (!answersResponse.ok) {
                    throw new Error(`HTTP error! status: ${answersResponse.status}`);
                }
                appState.answersData = await answersResponse.json();
                
                loadingText.textContent = 'Hoàn thành!';
                appState.isDataLoaded = true;
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 500);
                
                return true;
            } catch (error) {
                console.error('Error loading JSON data:', error);
                showErrorMessage(`Không thể tải dữ liệu: ${error.message}`);
                return false;
            }
        }

        function showErrorMessage(message) {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.innerHTML = `
                <div class="error-message">
                    <h3><i class="fas fa-exclamation-triangle"></i> Lỗi Tải Dữ Liệu</h3>
                    <p>${message}</p>
                    <p>Vui lòng kiểm tra:</p>
                    <ul style="text-align: left; margin: 15px 0;">
                        <li>File questions.json và answers.json có tồn tại không?</li>
                        <li>Đường dẫn file có đúng không?</li>
                        <li>Kết nối mạng có ổn định không?</li>
                    </ul>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Thử Lại
                    </button>
                </div>
            `;
        }

        // DOM Elements
        const elements = {
            exerciseSelection: document.getElementById('exercise-selection'),
            quizContainer: document.getElementById('quiz-container'),
            resultsContainer: document.getElementById('results-container'),
            quizTitle: document.getElementById('quiz-title'),
            quizProgressFill: document.getElementById('quiz-progress-fill'),
            quizProgressText: document.getElementById('quiz-progress-text'),
            japaneseSentence: document.getElementById('japanese-sentence'),
            vietnameseMeaning: document.getElementById('vietnamese-meaning'),
            sentencePrefix: document.getElementById('sentence-prefix'),
            answerInput: document.getElementById('answer-input'),
            feedback: document.getElementById('feedback'),
            hintBtn: document.getElementById('hint-btn'),
            checkBtn: document.getElementById('check-btn'),
            nextBtn: document.getElementById('next-btn'),
            skipBtn: document.getElementById('skip-btn')
        };

        // Modal Functions
        function showContinueModal(exerciseType, currentQuestion) {
            const modal = document.getElementById('continue-modal');
            const exerciseName = EXERCISE_DEFINITIONS[exerciseType].title;
            
            document.getElementById('continue-question-number').textContent = currentQuestion + 1;
            document.getElementById('continue-exercise-name').textContent = exerciseName;
            
            modal.classList.add('active');
        }

        function closeContinueModal() {
            document.getElementById('continue-modal').classList.remove('active');
        }

        function continueExercise() {
            closeContinueModal();
            const currentQuestion = appState.getExerciseProgress(appState.currentExercise);
            appState.currentQuestionIndex = currentQuestion;
            startExerciseFromIndex(appState.currentExercise, currentQuestion);
        }

        function restartExercise() {
            closeContinueModal();
            appState.clearExerciseProgress(appState.currentExercise);
            appState.currentQuestionIndex = 0;
            startExerciseFromIndex(appState.currentExercise, 0);
        }

        function showExportModal() {
            const modal = document.getElementById('export-modal');
            const tableBody = document.getElementById('export-table-body');
            const totalQuestions = document.getElementById('export-total-questions');
            
            // Clear previous data
            tableBody.innerHTML = '';
            
            let totalCount = 0;
            let questionNumber = 1;
            
            // Populate table with all questions
            Object.keys(EXERCISE_DEFINITIONS).forEach(exerciseKey => {
                const questions = appState.questionsData[exerciseKey] || [];
                const answers = appState.answersData[exerciseKey] || [];
                
                questions.forEach((question, index) => {
                    const answer = answers[index];
                    if (answer) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${questionNumber}</td>
                            <td style="font-family: 'Noto Sans JP', sans-serif;">${question.question}</td>
                            <td style="font-family: 'Noto Sans JP', sans-serif;">${answer.answer}</td>
                            <td>${question.meaning}</td>
                        `;
                        tableBody.appendChild(row);
                        questionNumber++;
                        totalCount++;
                    }
                });
            });
            
            totalQuestions.textContent = totalCount;
            modal.classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.remove('active');
        }

        function exportToExcel() {
            const table = document.getElementById('export-table');
            const workbook = XLSX.utils.table_to_book(table, {sheet: "Câu hỏi tiếng Nhật"});
            XLSX.writeFile(workbook, "cau_hoi_tieng_nhat.xlsx");
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'pt', 'a4');
            
            // Add UTF-8 font support for Vietnamese and Japanese
            pdf.setFontSize(12);
            
            let yPosition = 50;
            const pageHeight = pdf.internal.pageSize.height;
            const margin = 40;
            
            // Title
            pdf.setFontSize(16);
            pdf.text('Câu Hỏi Tiếng Nhật - Thể Thường', margin, yPosition);
            yPosition += 30;
            
            // Headers
            pdf.setFontSize(10);
            pdf.text('STT', margin, yPosition);
            pdf.text('Câu Hỏi', margin + 40, yPosition);
            pdf.text('Đáp Án', margin + 200, yPosition);
            pdf.text('Dịch Nghĩa', margin + 300, yPosition);
            yPosition += 20;
            
            // Draw line
            pdf.line(margin, yPosition, 550, yPosition);
            yPosition += 10;
            
            // Content
            let questionNumber = 1;
            Object.keys(EXERCISE_DEFINITIONS).forEach(exerciseKey => {
                const questions = appState.questionsData[exerciseKey] || [];
                const answers = appState.answersData[exerciseKey] || [];
                
                questions.forEach((question, index) => {
                    const answer = answers[index];
                    if (answer) {
                        if (yPosition > pageHeight - 50) {
                            pdf.addPage();
                            yPosition = 50;
                        }
                        
                        pdf.text(questionNumber.toString(), margin, yPosition);
                        
                        // Split long text if necessary
                        const questionText = pdf.splitTextToSize(question.question, 150);
                        const answerText = pdf.splitTextToSize(answer.answer, 80);
                        const meaningText = pdf.splitTextToSize(question.meaning, 150);
                        
                        pdf.text(questionText, margin + 40, yPosition);
                        pdf.text(answerText, margin + 200, yPosition);
                        pdf.text(meaningText, margin + 300, yPosition);
                        
                        yPosition += Math.max(questionText.length, answerText.length, meaningText.length) * 12 + 5;
                        questionNumber++;
                    }
                });
            });
            
            pdf.save('cau_hoi_tieng_nhat.pdf');
        }

        // Initialize the application
        async function initializeApp() {
            setupNavigation();
            loadTheme();
            
            // Load data first
            const dataLoaded = await loadJSONData();
            if (!dataLoaded) return;
            
            createExerciseCards();
            appState.updateStatsDisplay();
            setupKeyboardShortcuts();
        }

        // Navigation Setup
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    showPage(page);
                    updateActiveNav(link);
                });
            });
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`${page}-page`).classList.add('active');
        }

        function updateActiveNav(activeLink) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            activeLink.classList.add('active');
        }

        // Theme Management
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (body.dataset.theme === 'light') {
                body.dataset.theme = 'dark';
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                body.dataset.theme = 'light';
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.dataset.theme = savedTheme;
            document.getElementById('theme-icon').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Exercise Management
        function createExerciseCards() {
            if (!appState.isDataLoaded) return;
            
            const container = elements.exerciseSelection;
            container.innerHTML = '';

            Object.entries(EXERCISE_DEFINITIONS).forEach(([key, exercise]) => {
                const progress = appState.globalStats.exerciseProgress[key] || 0;
                const currentQuestion = appState.getExerciseProgress(key);
                const questions = appState.questionsData[key] || [];
                const progressPercent = questions.length > 0 ? (progress / questions.length) * 100 : 0;
                
                const card = document.createElement('div');
                card.className = 'exercise-card';
                card.onclick = () => startExercise(key);
                
                if (progress >= questions.length && questions.length > 0) {
                    card.classList.add('completed');
                }

                // Add resume indicator if there's progress
                let resumeIndicator = '';
                if (currentQuestion > 0 && currentQuestion < questions.length) {
                    resumeIndicator = `<div class="resume-indicator">Tiếp tục từ câu ${currentQuestion + 1}</div>`;
                }

                card.innerHTML = `
                    ${resumeIndicator}
                    <div class="exercise-title" style="color: ${exercise.color};">
                        <i class="${exercise.icon}"></i> ${exercise.title}
                    </div>
                    <div class="exercise-description">${exercise.description}</div>
                    <div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-secondary);">
                        Tiến độ: ${progress}/${questions.length} câu
                    </div>
                    <div class="exercise-progress">
                        <div class="exercise-progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Quiz Functions
        function startExercise(exerciseType) {
            if (!appState.isDataLoaded) {
                alert('Dữ liệu chưa được tải xong. Vui lòng đợi...');
                return;
            }

            appState.currentExercise = exerciseType;
            const currentQuestion = appState.getExerciseProgress(exerciseType);
            const questions = appState.questionsData[exerciseType];
            
            if (!questions || questions.length === 0) {
                alert('Bài tập này chưa có sẵn. Vui lòng thử bài tập khác!');
                return;
            }

            // Check if there's previous progress
            if (currentQuestion > 0 && currentQuestion < questions.length) {
                showContinueModal(exerciseType, currentQuestion);
                return;
            }

            // Start from beginning
            appState.currentQuestionIndex = 0;
            startExerciseFromIndex(exerciseType, 0);
        }

        function startExerciseFromIndex(exerciseType, startIndex) {
            appState.currentExercise = exerciseType;
            appState.currentQuestionIndex = startIndex;
            appState.sessionStats = { correct: 0, total: 0, streak: 0, skipped: 0 };
            appState.sessionResults = []; // Reset session results
            
            const questions = appState.questionsData[exerciseType];
            
            elements.exerciseSelection.style.display = 'none';
            elements.quizContainer.classList.add('active');
            elements.resultsContainer.style.display = 'none';
            
            elements.quizTitle.textContent = EXERCISE_DEFINITIONS[exerciseType].title;
            elements.quizProgressText.textContent = `${startIndex + 1}/${questions.length}`;
            
            loadQuestion();
        }

        function loadQuestion() {
            const questions = appState.questionsData[appState.currentExercise];
            const question = questions[appState.currentQuestionIndex];
            
            if (!question) {
                showResults();
                return;
            }

            // Save progress
            appState.saveExerciseProgress(appState.currentExercise, appState.currentQuestionIndex);

            // Update progress
            const progress = ((appState.currentQuestionIndex + 1) / questions.length) * 100;
            elements.quizProgressFill.style.width = progress + '%';
            elements.quizProgressText.textContent = `${appState.currentQuestionIndex + 1}/${questions.length}`;
            
            // Load question content
            elements.japaneseSentence.textContent = question.question;
            elements.vietnameseMeaning.textContent = question.meaning;
            elements.sentencePrefix.textContent = question.prefix;
            
            // Reset input and buttons
            elements.answerInput.value = '';
            elements.answerInput.focus();
            elements.feedback.innerHTML = '';
            elements.hintBtn.style.display = 'inline-flex';
            elements.checkBtn.style.display = 'inline-flex';
            elements.nextBtn.style.display = 'none';
            elements.skipBtn.style.display = 'inline-flex';

            // Update answer input placeholder
            elements.answerInput.placeholder = 'Nhập đáp án...';
        }

        function showHint() {
            const questions = appState.questionsData[appState.currentExercise];
            const question = questions[appState.currentQuestionIndex];
            
            elements.feedback.innerHTML = `
                <div class="feedback" style="background: linear-gradient(135deg, rgba(247, 206, 84, 0.1), rgba(248, 181, 0, 0.1)); color: var(--warning-color); border: 2px solid var(--warning-color);">
                    <i class="fas fa-lightbulb"></i> ${question.hint}
                </div>
            `;
        }

        function checkAnswer() {
            const questions = appState.questionsData[appState.currentExercise];
            const answers = appState.answersData[appState.currentExercise];
            const question = questions[appState.currentQuestionIndex];
            const answer = answers[appState.currentQuestionIndex];
            
            const userAnswer = elements.answerInput.value.trim().toLowerCase();
            const correctAnswer = answer.answer.toLowerCase();
            
            if (!userAnswer) {
                elements.answerInput.focus();
                return;
            }

            const isCorrect = userAnswer === correctAnswer;
            
            // Prepare question data for session results
            const questionData = {
                question: question.question,
                userAnswer: elements.answerInput.value.trim(),
                correctAnswer: answer.answer,
                explanation: answer.explanation,
                meaning: question.meaning
            };
            
            appState.updateStats(isCorrect, false, questionData);
            
            if (isCorrect) {
                elements.feedback.innerHTML = `
                    <div class="feedback correct">
                        <i class="fas fa-check-circle"></i> Chính xác! Đáp án đúng là: <strong>${answer.answer}</strong>
                        <br><small>${answer.explanation}</small>
                    </div>
                `;
                updateExerciseProgress();
            } else {
                elements.feedback.innerHTML = `
                    <div class="feedback incorrect">
                        <i class="fas fa-times-circle"></i> Chưa đúng! Đáp án đúng là: <strong>${answer.answer}</strong><br>
                        <small>Bạn đã nhập: "${userAnswer}"</small><br>
                        <small>${answer.explanation}</small>
                    </div>
                `;
            }

            elements.hintBtn.style.display = 'none';
            elements.checkBtn.style.display = 'none';
            elements.nextBtn.style.display = 'inline-flex';
            elements.skipBtn.style.display = 'none';
            elements.answerInput.disabled = true;
            
            setTimeout(() => {
                elements.answerInput.disabled = false;
            }, 1000);
        }

        function skipQuestion() {
            const questions = appState.questionsData[appState.currentExercise];
            const answers = appState.answersData[appState.currentExercise];
            const question = questions[appState.currentQuestionIndex];
            const answer = answers[appState.currentQuestionIndex];

            // Prepare question data for session results
            const questionData = {
                question: question.question,
                userAnswer: '',
                correctAnswer: answer.answer,
                explanation: answer.explanation,
                meaning: question.meaning
            };

            appState.updateStats(false, true, questionData);
            elements.feedback.innerHTML = `
                <div class="feedback" style="background: linear-gradient(135deg, rgba(156, 163, 175, 0.1), rgba(107, 114, 128, 0.1)); color: var(--text-secondary); border: 2px solid var(--text-secondary);">
                    <i class="fas fa-forward"></i> Đã bỏ qua câu hỏi này. Đáp án đúng là: <strong>${answer.answer}</strong>
                </div>
            `;
            
            elements.hintBtn.style.display = 'none';
            elements.checkBtn.style.display = 'none';
            elements.nextBtn.style.display = 'inline-flex';
            elements.skipBtn.style.display = 'none';
        }

        function nextQuestion() {
            appState.currentQuestionIndex++;
            const questions = appState.questionsData[appState.currentExercise];
            
            if (appState.currentQuestionIndex >= questions.length) {
                // Clear progress when exercise is completed
                appState.clearExerciseProgress(appState.currentExercise);
                showResults();
            } else {
                loadQuestion();
            }
        }

        function updateExerciseProgress() {
            const key = appState.currentExercise;
            if (!appState.globalStats.exerciseProgress[key]) {
                appState.globalStats.exerciseProgress[key] = 0;
            }
            appState.globalStats.exerciseProgress[key]++;
            appState.saveGlobalStats();
        }

        function showResults() {
            elements.quizContainer.classList.remove('active');
            elements.resultsContainer.style.display = 'block';
            
            const { correct, total, skipped } = appState.sessionStats;
            const wrong = total - correct - skipped;
            const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            document.getElementById('results-score').textContent = `${correct}/${total}`;
            document.getElementById('final-correct').textContent = correct;
            document.getElementById('final-wrong').textContent = wrong;
            document.getElementById('final-skipped').textContent = skipped;
            
            let message = '';
            if (percentage >= 90) {
                message = '🎉 Xuất sắc! Bạn đã làm rất tốt!';
            } else if (percentage >= 70) {
                message = '👍 Tốt lắm! Tiếp tục cố gắng!';
            } else if (percentage >= 50) {
                message = '😊 Không tệ! Hãy ôn lại và thử lần nữa!';
            } else {
                message = '💪 Đừng nản lòng! Hãy ôn lại lý thuyết và thử lại!';
            }
            
            document.getElementById('results-message').textContent = message;
            
            // Show answer review
            showAnswerReview();
            
            // Update exercise cards
            createExerciseCards();
        }

        function showAnswerReview() {
            const reviewContent = document.getElementById('review-content');
            reviewContent.innerHTML = '';
            
            appState.sessionResults.forEach((result, index) => {
                const reviewItem = document.createElement('div');
                reviewItem.className = 'review-item';
                
                if (result.isCorrect) {
                    reviewItem.classList.add('correct');
                } else if (result.isSkipped) {
                    reviewItem.classList.add('skipped');
                } else {
                    reviewItem.classList.add('incorrect');
                }
                
                let statusIcon = '';
                let answerText = '';
                
                if (result.isCorrect) {
                    statusIcon = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
                    answerText = `Đáp án của bạn: <strong>${result.userAnswer}</strong>`;
                } else if (result.isSkipped) {
                    statusIcon = '<i class="fas fa-forward" style="color: var(--warning-color);"></i>';
                    answerText = `Đã bỏ qua - Đáp án đúng: <strong>${result.correctAnswer}</strong>`;
                } else {
                    statusIcon = '<i class="fas fa-times-circle" style="color: var(--error-color);"></i>';
                    answerText = `Bạn trả lời: <strong>${result.userAnswer}</strong> | Đáp án đúng: <strong>${result.correctAnswer}</strong>`;
                }
                
                reviewItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        ${statusIcon}
                        <div class="review-question">${result.question}</div>
                    </div>
                    <div style="margin-left: 25px;">
                        <div class="review-answer">${answerText}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px;">
                            ${result.meaning}
                        </div>
                    </div>
                `;
                
                reviewContent.appendChild(reviewItem);
            });
        }

        function retryExercise() {
            startExercise(appState.currentExercise);
        }

        function backToSelection() {
            elements.exerciseSelection.style.display = 'grid';
            elements.quizContainer.classList.remove('active');
            elements.resultsContainer.style.display = 'none';
            createExerciseCards();
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (elements.quizContainer.classList.contains('active')) {
                    switch(e.key) {
                        case 'Enter':
                            if (elements.checkBtn.style.display !== 'none') {
                                e.preventDefault();
                                checkAnswer();
                            } else if (elements.nextBtn.style.display !== 'none') {
                                e.preventDefault();
                                nextQuestion();
                            }
                            break;
                        case 'h':
                        case 'H':
                            if (e.ctrlKey && elements.hintBtn.style.display !== 'none') {
                                e.preventDefault();
                                showHint();
                            }
                            break;
                        case 's':
                        case 'S':
                            if (e.ctrlKey && elements.skipBtn.style.display !== 'none') {
                                e.preventDefault();
                                skipQuestion();
                            }
                            break;
                        case 'Escape':
                            backToSelection();
                            break;
                    }
                }
            });
        }

        // Auto-save functionality
        setInterval(() => {
            appState.saveGlobalStats();
        }, APP_CONFIG.AUTO_SAVE_INTERVAL);

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Prevent form submission on Enter
        document.getElementById('answer-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        // Add focus management
        elements.answerInput.addEventListener('input', () => {
            // Auto-check if user presses space twice
            if (elements.answerInput.value.endsWith('  ')) {
                elements.answerInput.value = elements.answerInput.value.trim();
                if (elements.checkBtn.style.display !== 'none') {
                    checkAnswer();
                }
            }
        });

        // Performance optimization - debounced input
        let inputTimeout;
        elements.answerInput.addEventListener('input', () => {
            clearTimeout(inputTimeout);
            inputTimeout = setTimeout(() => {
                // Validate input here if needed
            }, 300);
        });
    </script>
</body>
</html>